{##################################################

Purpose:
Generating BGP Dual-Stack Underlay Configuration
###################################################}
router bgp {{ bgp.local_as }}
  router-id {{ lpbk_ulay.addr_v4 }}
  bgp bestpath as-path multipath-relax
  bgp log-neighbor-changes
  maximum-paths 4 ecmp 4
  no bgp bestpath ecmp-fast
  !
{% if peer-group.ipv4 is defined and peer-group.ipv4 %}
{% for group in peer-group.ipv4 %}
  neighbor {{ group.name }} peer group
  neighbor {{ group.name }} description {{ group.desc }}
  neighbor {{ group.name }} remote-as {{ group.remote_as }}
{% if group.attributes is defined and group.attributes %}
{% for attr in group.attributes %}
  neighbor {{ group.name }} {{ attr }}
{% endfor %}
{% endif %}
  !
{% endfor %}
{% endif %}
{% if peer-group.ipv6 is defined and peer-group.ipv6 %}
{% for group in peer-group.ipv6 %}
  neighbor {{ group.name }} peer group
  neighbor {{ group.name }} description {{ group.desc }}
  neighbor {{ group.name }} remote-as {{ group.remote_as }}
{% if group.attributes is defined and group.attributes %}
{% for attr in group.attributes %}
  neighbor {{ group.name }} {{ attr }}
{% endfor %}
{% endif %}
  !
{% endfor %}
{% endif %}
  address-family ipv4
{% if bgp.afi.ipv4 is defined and bgp.afi.ipv4 %}
{% for redis in bgp.afi.ipv4 %}
{% if redis.r_map %}
    redistribute {{ redis.proto }} route-map {{ redis.r_map }}
{% else %}
    redistribute {{ redis.proto }}
{% endif %}
{% endfor %}
{% endif %}
    !
{% if peer-group.ipv4 is defined and peer-group.ipv4 %}
{% for group in peer-group.ipv4 %}
    neighbor {{ group.name }} activate
{% endfor %}
{% endif %}
  !
  address-family ipv6
{% if bgp.afi.ipv6 is defined and bgp.afi.ipv6 %}
{% for redis in bgp.afi.ipv6 %}
{% if redis.r_map %}
    redistribute {{ redis.proto }} route-map {{ redis.r_map }}
{% else %}
    redistribute {{ redis.proto }}
{% endif %}
{% endfor %}
{% endif %}
    !
{% if peer-group.ipv4 is defined and peer-group.ipv4 %}
{% for group in peer-group.ipv4 %}
    no neighbor {{ group.name }} activate
{% endfor %}
{% endif %}
{% if peer-group.ipv6 is defined and peer-group.ipv6 %}
{% for group in peer-group.ipv6 %}
    neighbor {{ group.name }} activate
{% endfor %}
{% endif %}
  !
{% if bgp.peers is defined and bgp.peers %}
{% for peer in bgp.peers %}
  neighbor {{ peer.addr }} description "{{ peer.desc }}"
{% if peer.peer_group %}
  neighbor {{ peer.addr }} peer group {{ peer.peer_group }}
{% endif %}
{% if peer.remote_as %}
  neighbor {{ peer.addr }} remote-as {{ peer.remote_as }}
{% endif %}
  no shutdown
  !
{% endfor %}
{% endif %}
!



