---
- hosts: poc
  gather_facts: "false"
  collections:
  - arista.eos

  tasks:
  - name: Display UUT information
    debug:
      msg:
        - "The network model: {{ ansible_net_model }}"
        - "EOS Image version: {{ ansible_net_version }}"
    tags:
      - generic

  - name: Confirm Multi-Agent
    eos_command:
      commands:
        - show running-config | in multi-agent
      wait_for:
        - result[0] contains multi-agent
    register: show_output
    tags:
      - magent

  - name: Backup cfg
    arista.eos.eos_config:
      backup: yes
      backup_options:
        filename: "{{hostname}}.conf.backup"
        dir_path: "{{ build_dir }}"
    tags:
      - archive

  - name: Generate the intial configuration
    template:
        src: initial_cfg.j2
        dest: "files/{{hostname}}.conf.init"
    tags:
    - init_cfg

  - name: Collect Vxlan Logs
    eos_command:
      commands: "{{item}}"
    loop:
      - show interface vxlan1
      - show bgp summary
      - show bgp evpn summary
      - show bgp evpn route-type imet detail
      - show bgp evpn route-type mac-ip detail
      - show bgp evpn route-type ip-prefix ipv4 detail
    register: show_output
    tags:
      - vxlan

  - name: Display the Logs
    debug:
      msg:
        - "### The vxlan interface ###"
        - "{{ show_output.results[0].stdout_lines }}"
        - "### bgp summary ###"
        - "{{ show_output.results[1].stdout_lines }}"
        - "### bgp evpn summary ###"
        - "{{ show_output.results[2].stdout_lines }}"
        - "### evpn remote vtep type-3 ###"
        - "{{ show_output.results[3].stdout_lines }}"
        - "### evpn mac/ip type-2 ###"
        - "{{ show_output.results[4].stdout_lines }}"
        - "### evpn IP prefix type-5 ###"
        - "{{ show_output.results[5].stdout_lines }}"
    tags:
      - vxlan

  - name: CFG Changes
    arista.eos.eos_config:
      lines:
        - "no neighbor FABRIC-PEER_EVPN activate"
      parents: "address-family ipv4"
      before: "router bgp 12189"
      replace: line
    # loop:
    #   - "50"
    #   - "50.20"
    #   - "50.60"
    #   - "50.61"
    tags:
      - pnap

  - name: Flip the port
    eos_interfaces:
      config:
        - name: "Ethernet{{ item }}"
          enabled: true
    loop:
      - 1
      - 2
    tags:
      - port

  - name : "Remove BGPv4 Config"
    eos_config:
      lines:
        - "no router bgp {{ bgp.local_as }}"
    tags:
      - nobgp

  - name : "Shutdown the BGPv4 Peer"
    eos_config:
      lines:
        - "shutdown"
        - 
      parents: ['router bgp {{ bgp.local_as }}']
      match: exact
      # prompt: "[confirm]"
      # answer: "yes"
    notify:
    - display BGP info
    tags:
      - bgpdown

  - name : "Bringup the BGPv4 Peer"
    eos_config:
      lines:
        - "no shutdown"
      parents: ['router bgp {{ bgp.local_as }}']
      match: exact
    notify:
      - display BGP info
    tags:
      - bgpup

  - name: Wait 15 secs for BGP Peers coming up
    pause:
      seconds: 15
    delegate_to: localhost
    when: peerstate == "up"

  - name: Create a directory if it does not exist
    ansible.builtin.file:
      path: "~xji/devops/show_tech"
      state: directory
      mode: '0755'
    tags:
    - showtech

  - name: Collecting EOS Show Tech  
    block:
    - name: Collect show tech onto the local disk
      vars:
        ansible_timeout: 60
        ansible_command_timeout: 60
        ansible_connect_timeout: 60
      eos_command:
        commands: "show tech-support all > file:home/admin/show_tech_{{ inventory_hostname }}"

    - name: Fetch show tech file from switch to local host 
      ansible.builtin.expect:
          command: "scp admin@{{ ansible_host }}:/home/admin/show_tech_{{ inventory_hostname }} /home/xji/devops/show_tech/"
          responses:
              '\?': "yes"
              'Password\:': "{{ vault_ceos_password }}"
      delegate_to: localhost
      tags:
      - fetch
    tags:
    - showtech

  - name: Delete Layer2 Port
    eos_l2_interfaces:
        config:
        - name: Ethernet1
        - name: Ethernet2
        state: deleted
    tags:
      - del-layer2
